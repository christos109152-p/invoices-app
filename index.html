<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Σύστημα Τιμολογίων Pro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        function InvoiceApp() {
            const [invoices, setInvoices] = useState([]);
            const [loading, setLoading] = useState(false);
            const [predictions, setPredictions] = useState([]);
            const [activeTab, setActiveTab] = useState('upload');
            const [previewInvoice, setPreviewInvoice] = useState(null);
            const [editingInvoice, setEditingInvoice] = useState(null);
            const [gasUrl, setGasUrl] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [analytics, setAnalytics] = useState(null);

            useEffect(() => {
                const saved = localStorage.getItem('invoices');
                const savedUrl = localStorage.getItem('gasUrl');
                if (saved) {
                    try {
                        setInvoices(JSON.parse(saved));
                    } catch (e) {
                        console.error('Error loading:', e);
                    }
                }
                if (savedUrl) setGasUrl(savedUrl);
            }, []);

            useEffect(() => {
                if (invoices.length > 0) {
                    localStorage.setItem('invoices', JSON.stringify(invoices));
                    calculateAnalytics();
                    if (gasUrl) syncToGoogleSheets();
                }
            }, [invoices]);

            const syncToGoogleSheets = async () => {
                if (!gasUrl) return;
                
                try {
                    const data = invoices.flatMap(inv => 
                        inv.items.map(item => ({
                            date: inv.date,
                            supplier: inv.supplier,
                            invoice_number: inv.invoice_number,
                            product: item.product,
                            quantity: item.quantity,
                            unit: item.unit,
                            unit_price: item.unit_price,
                            total_price: item.total_price,
                            category: item.category
                        }))
                    );

                    await fetch(gasUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'write', data }),
                        mode: 'no-cors'
                    });
                    
                    console.log('Synced to Google Sheets');
                } catch (error) {
                    console.error('Sync error:', error);
                }
            };

            const calculateAnalytics = () => {
                const productStats = {};
                const supplierStats = {};
                
                invoices.forEach(inv => {
                    if (!supplierStats[inv.supplier]) {
                        supplierStats[inv.supplier] = { name: inv.supplier, invoiceCount: 0, totalSpent: 0 };
                    }
                    supplierStats[inv.supplier].invoiceCount++;
                    supplierStats[inv.supplier].totalSpent += inv.total_amount || 0;

                    inv.items.forEach(item => {
                        if (!productStats[item.product]) {
                            productStats[item.product] = {
                                product: item.product,
                                category: item.category,
                                unit: item.unit,
                                totalQuantity: 0,
                                totalSpent: 0,
                                orderCount: 0
                            };
                        }
                        
                        productStats[item.product].totalQuantity += item.quantity;
                        productStats[item.product].totalSpent += item.total_price;
                        productStats[item.product].orderCount++;
                    });
                });

                const topProducts = Object.values(productStats).sort((a, b) => b.totalSpent - a.totalSpent);
                const supplierList = Object.values(supplierStats).sort((a, b) => b.totalSpent - a.totalSpent);

                setAnalytics({
                    topProducts,
                    supplierList,
                    totalSpent: invoices.reduce((sum, inv) => sum + (inv.total_amount || 0), 0)
                });
            };

            const analyzeInvoiceWithClaude = async (file) => {
                const base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(",")[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                const isPDF = file.type === 'application/pdf';
                
                const promptText = `Αυτό είναι ένα ΕΛΛΗΝΙΚΟ τιμολόγιο. Εξάγε ΟΛΑ τα προϊόντα.

ΕΠΕΣΤΡΕΨΕ ΜΟΝΟ JSON:
{
  "invoice_number": "αριθμός",
  "date": "YYYY-MM-DD",
  "supplier": "προμηθευτής",
  "items": [{"product": "περιγραφή", "quantity": αριθμός, "unit": "μονάδα", "unit_price": αριθμός, "total_price": αριθμός, "category": "κατηγορία"}],
  "total_amount": σύνολο,
  "vat": ΦΠΑ,
  "notes": null
}`;

                const content = isPDF 
                    ? [{ type: "document", source: { type: "base64", media_type: "application/pdf", data: base64Data } }, { type: "text", text: promptText }]
                    : [{ type: "image", source: { type: "base64", media_type: file.type, data: base64Data } }, { type: "text", text: promptText }];

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 4000,
                        messages: [{ role: "user", content }]
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                let responseText = data.content[0].text.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                
                const parsed = JSON.parse(responseText);
                if (!parsed.items || parsed.items.length === 0) throw new Error('Δεν βρέθηκαν προϊόντα');
                
                return parsed;
            };

            const handleFileUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                
                setLoading(true);
                try {
                    const invoiceData = await analyzeInvoiceWithClaude(files[0]);
                    setPreviewInvoice({ ...invoiceData, fileName: files[0].name });
                } catch (error) {
                    alert(`Σφάλμα: ${error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const confirmInvoice = () => {
                if (previewInvoice) {
                    setInvoices(prev => [...prev, { ...previewInvoice, id: Date.now() + Math.random() }]);
                    setPreviewInvoice(null);
                    alert('✅ Αποθηκεύτηκε!');
                }
            };

            const exportData = () => {
                const dataStr = JSON.stringify({ invoices, exportDate: new Date().toISOString() }, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `invoices_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.invoices) {
                            setInvoices(data.invoices);
                            alert(`✅ Εισαγωγή ${data.invoices.length} τιμολογίων!`);
                        }
                    } catch (error) {
                        alert('❌ Σφάλμα: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            const saveGasUrl = () => {
                localStorage.setItem('gasUrl', gasUrl);
                setShowSettings(false);
                if (gasUrl && invoices.length > 0) syncToGoogleSheets();
                alert('✅ Συνδέθηκε!');
            };

            const generatePredictions = () => {
                if (invoices.length === 0) {
                    alert('Χρειάζονται τιμολόγια!');
                    return;
                }

                const productData = {};
                
                invoices.forEach(invoice => {
                    const month = new Date(invoice.date).getMonth();
                    
                    invoice.items.forEach(item => {
                        if (!productData[item.product]) {
                            productData[item.product] = {
                                product: item.product,
                                category: item.category,
                                unit: item.unit,
                                monthlyQuantities: Array(12).fill(0),
                                monthlyPrices: Array(12).fill(0),
                                counts: Array(12).fill(0),
                                totalOrders: 0,
                                lastOrderDate: invoice.date
                            };
                        }
                        
                        productData[item.product].monthlyQuantities[month] += item.quantity;
                        productData[item.product].monthlyPrices[month] += item.unit_price;
                        productData[item.product].counts[month]++;
                        productData[item.product].totalOrders++;
                    });
                });

                const currentMonth = new Date().getMonth();
                const nextMonth = (currentMonth + 1) % 12;
                
                const preds = Object.values(productData).map(data => {
                    const avgQuantity = data.counts[nextMonth] > 0 
                        ? data.monthlyQuantities[nextMonth] / data.counts[nextMonth]
                        : data.monthlyQuantities.reduce((a, b) => a + b, 0) / Math.max(data.totalOrders, 1);

                    const avgPrice = data.counts[nextMonth] > 0
                        ? data.monthlyPrices[nextMonth] / data.counts[nextMonth]
                        : data.monthlyPrices.reduce((a, b) => a + b, 0) / Math.max(data.totalOrders, 1);

                    const seasonalFactor = data.monthlyQuantities[nextMonth] > 0 
                        ? data.monthlyQuantities[nextMonth] / (data.monthlyQuantities.reduce((a, b) => a + b, 0) / 12 || 1)
                        : 1;

                    const predictedQuantity = Math.round(avgQuantity * seasonalFactor * 1.1 * 100) / 100;
                    
                    return {
                        product: data.product,
                        category: data.category,
                        predictedQuantity: predictedQuantity > 0 ? predictedQuantity : Math.ceil(avgQuantity * 100) / 100,
                        unit: data.unit,
                        estimatedTotal: (predictedQuantity * avgPrice).toFixed(2),
                        confidence: data.totalOrders >= 3 ? 'Υψηλή' : data.totalOrders >= 2 ? 'Μέτρια' : 'Χαμηλή'
                    };
                }).filter(p => p.predictedQuantity > 0);

                setPredictions(preds);
                setActiveTab('predictions');
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-4 mb-4">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <h1 className="text-2xl md:text-3xl font-bold text-gray-800">📊 Σύστημα Τιμολογίων Pro</h1>
                                    <p className="text-sm text-gray-600 mt-1">{invoices.length} τιμολόγια • {invoices.reduce((s, i) => s + i.items.length, 0)} προϊόντα</p>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    <button onClick={() => setShowSettings(true)} className="bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 text-sm">⚙️ Setup</button>
                                    <button onClick={exportData} className="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm" disabled={invoices.length === 0}>💾 Export</button>
                                    <label className="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 cursor-pointer text-sm">
                                        📁 Import
                                        <input type="file" className="hidden" accept=".json" onChange={importData} />
                                    </label>
                                </div>
                            </div>
                        </div>

                        {showSettings && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-lg p-6 max-w-2xl w-full">
                                    <h2 className="text-2xl font-bold mb-4">⚙️ Google Sheets Setup</h2>
                                    <div className="bg-blue-50 border border-blue-200 rounded p-4 mb-4 text-sm">
                                        <p className="font-semibold mb-2">Οδηγίες:</p>
                                        <ol className="list-decimal list-inside space-y-1">
                                            <li>Δημιούργησε Google Sheet</li>
                                            <li>Extensions → Apps Script</li>
                                            <li>Επικόλλησε το script</li>
                                            <li>Deploy → Web app</li>
                                            <li>Copy το URL εδώ:</li>
                                        </ol>
                                    </div>
                                    <input
                                        type="text"
                                        value={gasUrl}
                                        onChange={(e) => setGasUrl(e.target.value)}
                                        placeholder="https://script.google.com/macros/s/.../exec"
                                        className="w-full border rounded px-3 py-2 mb-4"
                                    />
                                    <div className="flex gap-3">
                                        <button onClick={saveGasUrl} className="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-bold">Αποθήκευση</button>
                                        <button onClick={() => setShowSettings(false)} className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 font-bold">Άκυρο</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {previewInvoice && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto">
                                    <h2 className="text-2xl font-bold mb-4">👁️ Προεπισκόπηση</h2>
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div><strong>Προμηθευτής:</strong> {previewInvoice.supplier}</div>
                                        <div><strong>Αρ. Τιμολογίου:</strong> {previewInvoice.invoice_number}</div>
                                        <div><strong>Ημερομηνία:</strong> {previewInvoice.date}</div>
                                        <div><strong>Σύνολο:</strong> €{previewInvoice.total_amount?.toFixed(2)}</div>
                                    </div>
                                    <div className="overflow-x-auto border rounded mb-4">
                                        <table className="w-full text-sm">
                                            <thead className="bg-indigo-600 text-white">
                                                <tr>
                                                    <th className="p-2">#</th>
                                                    <th className="p-2 text-left">Προϊόν</th>
                                                    <th className="p-2">Ποσότητα</th>
                                                    <th className="p-2 text-right">Τιμή</th>
                                                    <th className="p-2 text-right">Σύνολο</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {previewInvoice.items.map((item, idx) => (
                                                    <tr key={idx} className="border-b">
                                                        <td className="p-2 font-bold">{idx + 1}</td>
                                                        <td className="p-2">{item.product}</td>
                                                        <td className="p-2 text-center">{item.quantity} {item.unit}</td>
                                                        <td className="p-2 text-right">€{item.unit_price?.toFixed(2)}</td>
                                                        <td className="p-2 text-right font-semibold">€{item.total_price?.toFixed(2)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={confirmInvoice} className="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-bold">✅ Αποθήκευση</button>
                                        <button onClick={() => setPreviewInvoice(null)} className="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 font-bold">❌ Ακύρωση</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white rounded-lg shadow-lg">
                            <div className="flex overflow-x-auto border-b">
                                {['upload', 'data', 'analytics', 'predictions'].map(tab => (
                                    <button
                                        key={tab}
                                        onClick={() => setActiveTab(tab)}
                                        className={`flex-1 py-3 px-4 font-semibold text-sm ${activeTab === tab ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600'}`}
                                    >
                                        {tab === 'upload' && '📤 Μεταφόρτωση'}
                                        {tab === 'data' && '📊 Δεδομένα'}
                                        {tab === 'analytics' && '📈 Αναλύσεις'}
                                        {tab === 'predictions' && '🔮 Προβλέψεις'}
                                    </button>
                                ))}
                            </div>

                            {activeTab === 'upload' && (
                                <div className="p-6">
                                    <div className="max-w-2xl mx-auto">
                                        <label className="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed border-indigo-300 rounded-lg cursor-pointer hover:border-indigo-500 hover:bg-indigo-50">
                                            <div className="text-center">
                                                <div className="text-6xl mb-4">📤</div>
                                                <p className="text-lg font-semibold">Μεταφόρτωση Τιμολογίων</p>
                                                <p className="text-sm text-gray-500">PDF ή Φωτογραφίες</p>
                                            </div>
                                            <input type="file" className="hidden" accept="application/pdf,image/*" onChange={handleFileUpload} disabled={loading} />
                                        </label>
                                        {loading && <div className="mt-6 text-center"><div className="inline-block animate-spin rounded-full h-10 w-10 border-4 border-indigo-600 border-t-transparent"></div><p className="mt-3">Ανάλυση με AI...</p></div>}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'data' && (
                                <div className="p-4">
                                    <h2 className="text-xl font-bold mb-4">Δεδομένα</h2>
                                    {invoices.length > 0 ? (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead className="bg-indigo-600 text-white">
                                                    <tr>
                                                        <th className="p-2 text-left">Ημ/νία</th>
                                                        <th className="p-2 text-left">Προμηθευτής</th>
                                                        <th className="p-2 text-left">Προϊόν</th>
                                                        <th className="p-2 text-right">Σύνολο</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {invoices.map(inv => 
                                                        inv.items.map((item, idx) => (
                                                            <tr key={`${inv.id}-${idx}`} className="border-b">
                                                                {idx === 0 && <><td className="p-2" rowSpan={inv.items.length}>{inv.date}</td><td className="p-2 font-semibold" rowSpan={inv.items.length}>{inv.supplier}</td></>}
                                                                <td className="p-2">{item.product}</td>
                                                                <td className="p-2 text-right">€{item.total_price?.toFixed(2)}</td>
                                                            </tr>
                                                        ))
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    ) : (
                                        <div className="text-center py-12 text-gray-500">Δεν υπάρχουν δεδομένα</div>
                                    )}
                                </div>
                            )}

                            {activeTab === 'analytics' && (
                                <div className="p-4">
                                    {analytics ? (
                                        <div>
                                            <h2 className="text-2xl font-bold mb-4">📊 Αναλύσεις</h2>
                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
                                                <div className="bg-blue-500 text-white rounded-lg p-4">
                                                    <div className="text-xs">Συνολικές Δαπάνες</div>
                                                    <div className="text-xl font-bold">€{analytics.totalSpent.toFixed(2)}</div>
                                                </div>
                                                <div className="bg-green-500 text-white rounded-lg p-4">
                                                    <div className="text-xs">Προϊόντα</div>
                                                    <div className="text-xl font-bold">{analytics.topProducts.length}</div>
                                                </div>
                                                <div className="bg-purple-500 text-white rounded-lg p-4">
                                                    <div className="text-xs">Προμηθευτές</div>
                                                    <div className="text-xl font-bold">{analytics.supplierList.length}</div>
                                                </div>
                                            </div>
                                            <div className="bg-white border rounded-lg p-4">
                                                <h3 className="font-bold mb-4">Top 10 Προϊόντα</h3>
                                                {analytics.topProducts.slice(0, 10).map((prod, idx) => (
                                                    <div key={idx} className="flex justify-between items-center py-2 border-b">
                                                        <div>
                                                            <div className="font-semibold">{idx + 1}. {prod.product}</div>
                                                            <div className="text-xs text-gray-600">{prod.orderCount} παραγγελίες</div>
                                                        </div>
                                                        <div className="text-lg font-bold text-green-600">€{prod.totalSpent.toFixed(2)}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-12 text-gray-500">Πρόσθεσε τιμολόγια!</div>
                                    )}
                                </div>
                            )}

                            {activeTab === 'predictions' && (
                                <div className="p-4">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-bold">Προβλέψεις</h2>
                                        <button onClick={generatePredictions} className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700" disabled={invoices.length === 0}>Δημιουργία</button>
                                    </div>
                                    {predictions.length > 0 ? (
                                        <div className="space-y-3">
                                            {predictions.map((pred, idx) => (
                                                <div key={idx} className="bg-green-50 border border-green-200 rounded-lg p-4">
                                                    <div className="flex justify-between">
                                                        <div>
                                                            <div className="font-bold">{pred.product}</div>
                                                            <div className="text-sm text-gray-600">{pred.category}</div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="font-bold text-indigo-600">{pred.predictedQuantity} {pred.unit}</div>
                                                            <div className="text-sm text-green-600">€{pred.estimatedTotal}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-center py-12 text-gray-500">Πάτα "Δημιουργία"</div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<InvoiceApp />, document.getElementById('root'));
    </script>
</body>
</html>